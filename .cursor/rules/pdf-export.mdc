---
alwaysApply: false
description: Guidelines for PDF export functionality, font management, and optimization
---

# PDF Export System

## Current Implementation

The PDF export system successfully uses UntitledSans throughout the entire pipeline:
- **Web UI**: Uses UntitledSans for consistent brand typography
- **PDF Preview Modal**: UntitledSans with real-time generation
- **PDF Export**: UntitledSans with optimized layout and spacing

### Typography Success

**UntitledSans Integration Achieved:**
- ✅ **Font Registration**: Multiple variants (Light, Regular, Medium, Bold) with italic styles
- ✅ **TTF Format**: Uses `.ttf` files for reliable react-pdf compatibility
- ✅ **Glyph Rendering**: Proper character display across all PDF viewers
- ✅ **Brand Consistency**: Unified typography between web and PDF

## Architecture

The PDF system uses a modular component architecture:

```
CarrierBagPDFDocument
├── PDFCoverPage
│   ├── Title, subtitle, and metadata
│   ├── Pattern count and date
│   └── Logo integration (SVG→PNG)
├── PDFTableOfContents (conditional)
│   ├── Pattern list with page numbers
│   └── Navigation structure
└── PDFPatternPage (per pattern)
    ├── PDFPatternConnections
    ├── PDFSolutions
    ├── PDFResources
    └── PDFPatternNotes
```

### Core Components

- **[pdf-components.tsx](mdc:src/components/pdf/pdf-components.tsx)**: All PDF-specific React components
- **[pdf-preview-modal.tsx](mdc:src/components/pdf/pdf-preview-modal.tsx)**: Preview functionality with memory management
- **[use-pattern-content.ts](mdc:src/hooks/use-pattern-content.ts)**: Data transformation and content processing
- **[pattern-styles.ts](mdc:src/lib/pattern-styles.ts)**: Unified design tokens and style system
- **[style-adapters.ts](mdc:src/lib/style-adapters.ts)**: Style conversion between web and PDF formats

## Font Management

### UntitledSans Registration

```typescript
Font.register({
  family: "UntitledSans",
  src: "/fonts/UntitledSans/UntitledSans-Light.ttf",
  fontWeight: 300,
  fontStyle: "normal",
});
// Additional variants: Regular, Medium, Bold + Italic styles
```

### Font Requirements
- **Format**: TTF files for react-pdf compatibility
- **Location**: `/public/fonts/UntitledSans/` directory
- **Variants**: Light (300), Regular (400), Medium (500), Bold (700)
- **Styles**: Normal and Italic for each weight

## Style System

### Design Tokens
The system uses centralized design tokens in [pattern-styles.ts](mdc:src/lib/pattern-styles.ts):

```typescript
export const designTokens = {
  colors: { primary, secondary, muted, tag, audience },
  typography: { fontFamily, sizes, weights, lineHeights },
  spacing: { xs: 4, sm: 8, md: 12, lg: 16, xl: 20, "2xl": 24 },
  borders: { radius, width }
};
```

### Style Adapters
- **Web**: Converts to Tailwind classes via `toTailwindClasses()`
- **PDF**: Converts to react-pdf styles via `toPDFStyle()`
- **Text Transform**: Manual implementation since react-pdf doesn't support CSS text-transform

## Performance Optimizations

### Memory Management
- **Object URL Cleanup**: Automatic revocation to prevent memory leaks
- **SVG Caching**: Cached PNG conversion for logos and icons
- **Pattern Count Tracking**: Prevents unnecessary PDF regeneration

### SVG to PNG Conversion
Uses [svg-to-png.ts](mdc:src/lib/svg-to-png.ts) for PDF-compatible image assets:

```typescript
const logoDataUri = await svgToPngCached("/pattern-logo.svg", {
  width: 16,
  height: 16,
  scale: 2, // High resolution for crisp rendering
});
```

## Layout Specifications

### Typography Scale
- **Cover Title**: 28px (font-light)
- **Pattern Title**: 28px (reduced from 32px for better fit)
- **Section Titles**: 26px (reduced from 32px)
- **Solution Titles**: 18px
- **Body Text**: 14px with 1.6 line height
- **Tags/Meta**: 10-12px

### Spacing System
- **Page Margins**: 40px all sides
- **Solution Gap**: 20px (reduced from 32px)
- **Solution Number Width**: 30px (optimized for roman numerals)
- **Tag Container Gap**: 6px
- **Section Margins**: 25-30px

### Page Elements
- **Watermark**: Bottom center with OEDP icon and date
- **Pattern Label**: Rotated text in top margin
- **Page Breaks**: Each pattern starts on new page
- **TOC**: Only shown for multi-pattern exports

## Error Handling

### Graceful Degradation
- **Logo Failure**: Continue PDF generation without logo if conversion fails
- **Font Loading**: Fallback to system fonts if UntitledSans unavailable
- **Empty Content**: Validation for minimum pattern count
- **Memory Cleanup**: Automatic cleanup on component unmount

### Error Boundaries
```typescript
try {
  const blob = await pdf(<CarrierBagPDFDocument />).toBlob();
  // Handle success
} catch (error) {
  console.error("Error generating PDF:", error);
  throw new Error("Failed to generate PDF");
}
```

## Development Guidelines

### Adding New PDF Components
1. **Style Definition**: Add styles to [pattern-styles.ts](mdc:src/lib/pattern-styles.ts) design tokens
2. **Component Creation**: Build in [pdf-components.tsx](mdc:src/components/pdf/pdf-components.tsx)
3. **Style Adaptation**: Ensure web compatibility via [style-adapters.ts](mdc:src/lib/style-adapters.ts)
4. **Testing**: Verify both preview modal and download functionality

### Style Consistency Rules
- **Use Design Tokens**: Always reference `designTokens` for values
- **Text Transform**: Use `applyTextTransform()` helper for react-pdf compatibility
- **Responsive Sizing**: Consider A4 page constraints (595px width)
- **Line Heights**: Maintain hierarchy (1.3 titles, 1.6 body text)

### Font Modification Process
1. **Font Files**: Update TTF files in `/public/fonts/UntitledSans/`
2. **Registration**: Update font registration in [pdf-components.tsx](mdc:src/components/pdf/pdf-components.tsx)
3. **Style Tokens**: Adjust font-family in [pattern-styles.ts](mdc:src/lib/pattern-styles.ts)
4. **Testing**: Verify rendering across different browsers and PDF viewers

## Future Enhancements

### Potential Improvements
- **Page Numbering**: Add automatic page numbers to multi-page exports
- **Bookmarks**: PDF navigation bookmarks for patterns
- **Custom Themes**: User-selectable color schemes
- **Print Optimization**: Additional print-specific styling
- **Accessibility**: PDF accessibility tags and structure

### Monitoring
- **Performance**: Track PDF generation time for large carrier bags
- **Font Loading**: Monitor font availability across environments
- **Memory Usage**: Watch for memory leaks in preview modal
- **Error Rates**: Track PDF generation failure rates